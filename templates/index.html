<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleSubCipher - Web Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            margin-bottom: 1.5rem;
        }
        .monospace {
            font-family: 'Courier New', monospace;
            background-color: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
        .progress {
            height: 25px;
        }
        .bigram-plot {
            max-width: 100%;
            height: auto;
        }
        #fitness-plot {
            max-width: 100%;
            height: auto;
        }
        .alphabet-display {
            letter-spacing: 0.5rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-lock"></i> SimpleSubCipher
            </span>
            <span class="navbar-text">
                Monoalphabetic Substitution Cipher Cryptanalysis
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alphabet Display -->
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Supported Alphabet</h6>
                <div class="monospace alphabet-display">ABCDEFGHIJKLMNOPQRSTUVWXYZ_</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="encrypt-tab" data-bs-toggle="tab" data-bs-target="#encrypt" type="button">
                    <i class="fas fa-lock"></i> Encrypt/Decrypt
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analyze-tab" data-bs-toggle="tab" data-bs-target="#analyze" type="button">
                    <i class="fas fa-chart-line"></i> Cryptanalysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bigram-tab" data-bs-toggle="tab" data-bs-target="#bigram" type="button">
                    <i class="fas fa-table"></i> Bigram Analysis
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Encrypt/Decrypt Tab -->
            <div class="tab-pane fade show active" id="encrypt" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Encrypt Text</h5>
                        <div class="mb-3">
                            <label for="plaintext" class="form-label">Plaintext</label>
                            <textarea class="form-control monospace" id="plaintext" rows="3" 
                                placeholder="Enter text to encrypt..."></textarea>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="loadSampleText()">
                                Load Sample Text
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="encrypt-key" class="form-label">Key (leave empty for random)</label>
                            <input type="text" class="form-control monospace" id="encrypt-key" 
                                placeholder="e.g., QWERTYUIOPASDFGHJKLZXCVBNM_">
                        </div>
                        <button class="btn btn-primary" onclick="encryptText()">
                            <i class="fas fa-lock"></i> Encrypt
                        </button>
                        <div id="encrypt-result" class="mt-3"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Decrypt Text</h5>
                        <div class="mb-3">
                            <label for="ciphertext" class="form-label">Ciphertext</label>
                            <textarea class="form-control monospace" id="ciphertext" rows="3" 
                                placeholder="Enter encrypted text..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="decrypt-key" class="form-label">Key (required)</label>
                            <input type="text" class="form-control monospace" id="decrypt-key" 
                                placeholder="e.g., QWERTYUIOPASDFGHJKLZXCVBNM_" required>
                        </div>
                        <button class="btn btn-success" onclick="decryptText()">
                            <i class="fas fa-unlock"></i> Decrypt
                        </button>
                        <div id="decrypt-result" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Cryptanalysis Tab -->
            <div class="tab-pane fade" id="analyze" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Automatic Cryptanalysis</h5>
                        <p class="text-muted">Uses Metropolis-Hastings algorithm with Czech bigram frequencies</p>
                        
                        <div class="mb-3">
                            <label for="analyze-ciphertext" class="form-label">Ciphertext to Analyze</label>
                            <textarea class="form-control monospace" id="analyze-ciphertext" rows="4" 
                                placeholder="Enter encrypted text to break..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="iterations" class="form-label">Iterations</label>
                            <input type="number" class="form-control" id="iterations" 
                                value="10000" min="1000" max="50000" step="1000">
                            <small class="text-muted">More iterations = better results but slower</small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="startAnalysis()">
                            <i class="fas fa-search"></i> Start Cryptanalysis
                        </button>
                        
                        <div id="analysis-progress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                    role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div id="analysis-result" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Bigram Tab -->
            <div class="tab-pane fade" id="bigram" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Czech Bigram Frequency Analysis</h5>
                        <p class="text-muted">Based on Krakatit corpus (450k+ characters)</p>
                        
                        <button class="btn btn-primary mb-3" onclick="loadBigramMatrix()">
                            <i class="fas fa-chart-bar"></i> Load Bigram Matrix
                        </button>
                        
                        <div id="bigram-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentTaskId = null;
        let progressInterval = null;

        function encryptText() {
            const plaintext = $('#plaintext').val();
            const key = $('#encrypt-key').val();
            
            $.ajax({
                url: '/api/encrypt',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ plaintext, key }),
                success: function(data) {
                    $('#encrypt-result').html(`
                        <div class="alert alert-success">
                            <h6>Encryption Result</h6>
                            <p><strong>Processed Text:</strong><br>
                                <span class="monospace">${data.plaintext}</span></p>
                            <p><strong>Ciphertext:</strong><br>
                                <span class="monospace">${data.ciphertext}</span></p>
                            <p><strong>Key Used:</strong><br>
                                <span class="monospace">${data.key}</span></p>
                            <button class="btn btn-sm btn-secondary" 
                                onclick="copyToDecrypt('${data.ciphertext}', '${data.key}')">
                                Copy to Decrypt Tab
                            </button>
                        </div>
                    `);
                },
                error: function(xhr) {
                    $('#encrypt-result').html(`
                        <div class="alert alert-danger">
                            Error: ${xhr.responseJSON.error}
                        </div>
                    `);
                }
            });
        }

        function decryptText() {
            const ciphertext = $('#ciphertext').val();
            const key = $('#decrypt-key').val();
            
            $.ajax({
                url: '/api/decrypt',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ciphertext, key }),
                success: function(data) {
                    $('#decrypt-result').html(`
                        <div class="alert alert-success">
                            <h6>Decryption Result</h6>
                            <p><strong>Plaintext:</strong><br>
                                <span class="monospace">${data.plaintext}</span></p>
                        </div>
                    `);
                },
                error: function(xhr) {
                    $('#decrypt-result').html(`
                        <div class="alert alert-danger">
                            Error: ${xhr.responseJSON.error}
                        </div>
                    `);
                }
            });
        }

        function startAnalysis() {
            const ciphertext = $('#analyze-ciphertext').val();
            const iterations = $('#iterations').val();
            
            if (!ciphertext) {
                alert('Please enter ciphertext to analyze');
                return;
            }
            
            $('#analysis-progress').show();
            $('#analysis-result').empty();
            
            $.ajax({
                url: '/api/analyze',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ciphertext, iterations: parseInt(iterations) }),
                success: function(data) {
                    currentTaskId = data.task_id;
                    checkProgress();
                }
            });
        }

        function checkProgress() {
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(function() {
                $.get(`/api/analyze/${currentTaskId}`, function(data) {
                    const progressBar = $('.progress-bar');
                    progressBar.css('width', data.progress + '%');
                    progressBar.text(data.progress + '%');
                    
                    if (data.status === 'completed') {
                        clearInterval(progressInterval);
                        $('#analysis-progress').hide();
                        showAnalysisResult(data);
                    } else if (data.status === 'failed') {
                        clearInterval(progressInterval);
                        $('#analysis-progress').hide();
                        $('#analysis-result').html(`
                            <div class="alert alert-danger">
                                Analysis failed: ${data.error}
                            </div>
                        `);
                    }
                });
            }, 500);
        }

        function showAnalysisResult(data) {
            $('#analysis-result').html(`
                <div class="alert alert-success">
                    <h6>Cryptanalysis Complete!</h6>
                    <p><strong>Recovered Plaintext:</strong><br>
                        <span class="monospace">${data.plaintext}</span></p>
                    <p><strong>Found Key:</strong><br>
                        <span class="monospace">${data.key}</span></p>
                    <p><strong>Final Fitness Score:</strong> ${data.fitness.toFixed(4)}</p>
                    <p><strong>Iterations:</strong> ${data.iterations}</p>
                    
                    <h6 class="mt-3">Fitness Evolution</h6>
                    <img src="data:image/png;base64,${data.fitness_plot}" 
                        class="img-fluid" id="fitness-plot">
                </div>
            `);
        }

        function loadBigramMatrix() {
            $('#bigram-result').html('<div class="text-center"><div class="spinner-border"></div></div>');
            
            $.get('/api/bigram_matrix', function(data) {
                let bigramTable = '<h6>Top 20 Bigrams</h6><table class="table table-sm"><thead><tr><th>Bigram</th><th>Probability</th></tr></thead><tbody>';
                
                data.top_bigrams.forEach(function(item) {
                    bigramTable += `<tr><td class="monospace">${item.bigram}</td><td>${item.percentage.toFixed(2)}%</td></tr>`;
                });
                
                bigramTable += '</tbody></table>';
                
                $('#bigram-result').html(`
                    <div class="row">
                        <div class="col-md-8">
                            <img src="data:image/png;base64,${data.plot}" class="bigram-plot img-fluid">
                        </div>
                        <div class="col-md-4">
                            ${bigramTable}
                        </div>
                    </div>
                `);
            });
        }

        function loadSampleText() {
            $.get('/api/sample_text', function(data) {
                const randomSample = data.samples[Math.floor(Math.random() * data.samples.length)];
                $('#plaintext').val(randomSample);
            });
        }

        function copyToDecrypt(ciphertext, key) {
            $('#ciphertext').val(ciphertext);
            $('#decrypt-key').val(key);
            $('button[data-bs-target="#encrypt"]').removeClass('active');
            $('#encrypt').removeClass('show active');
            $('button[data-bs-target="#analyze"]').addClass('active');
            $('#analyze').addClass('show active');
        }
    </script>
</body>
</html>